<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2D Transmission Line Field Solver</title>
    <style>
        :root {
            --bg-color: #f4f4f9;
            --panel-color: #ffffff;
            --primary-color: #2563eb;
            --text-color: #1f2937;
            --border-color: #e5e7eb;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar Layout */
        .sidebar {
            width: 320px;
            background-color: var(--panel-color);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow: hidden;
        }

        /* Form Elements */
        h2, h3 { margin-top: 0; font-size: 1.1em; color: #111827; }
        h2 { font-size: 1.4em; margin-bottom: 20px; }

        .control-group { margin-bottom: 15px; }
        .control-group label { display: block; font-size: 0.85em; font-weight: 500; margin-bottom: 5px; color: #4b5563; }

        .input-row { display: flex; gap: 10px; align-items: center; }
        input[type="number"], input[type="text"], select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.9em;
        }
        input.unit-input {
            font-family: 'Consolas', 'Monaco', monospace;
        }
        input.unit-parsed {
            background-color: #f0f9ff;
        }
        input.unit-input.invalid {
            border-color: #dc2626;
            box-shadow: 0 0 0 3px rgba(220,38,38,0.2);
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
            transition: background-color 0.2s;
        }
        button:hover { background-color: #1d4ed8; }
        button:disabled { background-color: #93c5fd; cursor: wait; }
        button.stop-mode {
            background-color: #dc2626;
        }
        button.stop-mode:hover {
            background-color: #b91c1c;
        }

        /* Visualization Area */
        .canvas-container {
            flex: 1;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #sim_canvas {
            width: 100%;
            height: 100%;
        }

        canvas { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }

        #sim_canvas {
            position: relative;
            z-index: 1;
        }

        /* Output Console */
        .output-panel {
            height: 150px;
            margin-top: 20px;
            background: #1e1e1e;
            color: #00ff00;
            font-family: 'Consolas', 'Monaco', monospace;
            padding: 15px;
            border-radius: 8px;
            font-size: 0.85em;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        /* Progress Bar */
        .progress-container {
            height: 6px;
            background: #e5e7eb;
            margin-top: 10px;
            border-radius: 3px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: var(--primary-color);
            width: 0%;
            transition: width 0.1s;
        }

        /* Tab Bar */
        .tab-bar {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            background: #f5f5f5;
            margin-bottom: 0;
        }
        .tab-button {
            padding: 10px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-weight: 500;
            color: #6b7280;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            width: auto;
        }
        .tab-button:hover {
            background: #e5e7eb;
            color: #1f2937;
        }
        .tab-button.active {
            background: white;
            border-bottom: 2px solid var(--primary-color);
            color: var(--primary-color);
        }
        .tab-content {
            display: none;
            height: 100%;
            flex: 1;
        }
        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        /* Results Tab */
        .results-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px 15px;
            background: #f9fafb;
            border-bottom: 1px solid var(--border-color);
        }
        .results-controls.bottom {
            border-bottom: none;
            border-top: 1px solid var(--border-color);
            flex-wrap: wrap;
        }
        .results-controls.bottom button {
            width: auto;
            padding: 8px 16px;
        }
        .results-controls select {
            padding: 6px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.9em;
        }
        .plot-container {
            flex: 1;
            min-height: 400px;
        }

        /* S-Parameters Tab */
        .sparam-controls {
            display: flex;
            gap: 20px;
            padding: 10px 15px;
            background: #f9fafb;
            border-top: 1px solid var(--border-color);
            align-items: center;
            flex-wrap: wrap;
        }
        .sparam-controls label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }
        .sparam-controls input[type="number"] {
            width: 80px;
            padding: 6px 8px;
        }
        .sparam-controls button {
            width: auto;
            padding: 8px 16px;
        }
        .sparam-controls button:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }

        /* Checkbox labels */
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9em;
            cursor: pointer;
        }
        .checkbox-label input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
        .results-controls .checkbox-label {
            margin-left: 0;
        }

        /* Help Icon */
        .help-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            line-height: 14px;
            text-align: center;
            border-radius: 50%;
            border: 1px solid #6b7280;
            color: #6b7280;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            margin-left: 5px;
            vertical-align: middle;
            transition: all 0.2s;
        }
        .help-icon:hover {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Help Modal */
        .help-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .help-modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 8px;
            max-width: 500px;

        }
        .help-modal-close {
            color: #9ca3af;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 20px;
        }
        .help-modal-close:hover {
            color: #1f2937;
        }
        .help-modal h3 {
            margin-top: 0;
            color: #111827;
        }
        .help-modal p {
            line-height: 1.6;
            color: #4b5563;
        }
        .help-modal a {
            color: var(--primary-color);
            text-decoration: none;
        }
        .help-modal a:hover {
            text-decoration: underline;
        }

        /* About Tab */
        .about-content {
            padding: 30px;
            max-width: 800px;
            line-height: 1.6;
            overflow-y: auto;
        }
        .about-content h2 {
            color: #1f2937;
            margin-bottom: 15px;
        }
        .about-content h3 {
            color: #374151;
            margin-top: 25px;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        .about-content p {
            color: #4b5563;
            margin-bottom: 12px;
        }
        .about-content a {
            color: var(--primary-color);
            text-decoration: none;
        }
        .about-content a:hover {
            text-decoration: underline;
        }

        /* Collapsible Sections */
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            padding: 8px 0;
            margin: 10px 0 5px 0;
            user-select: none;
        }
        .section-header h3 {
            margin: 0;
            flex: 1;
        }
        .section-header::after {
            content: '▼';
            font-size: 0.7em;
            color: #6b7280;
            transition: transform 0.2s;
        }
        .section-header.collapsed::after {
            transform: rotate(-90deg);
        }
        .section-content {
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            max-height: 1000px;
        }
        .section-content.collapsed {
            max-height: 0;
        }
    </style>
<script src="plotly-2.27.0.min.js.js"></script>
</head>
<body>

<div class="sidebar">
    <div class="control-group">
        <label for="tl_type">Transmission Line Type</label>
        <select id="tl_type">
            <option value="microstrip">Microstrip</option>
            <option value="diff_microstrip">Differential Microstrip</option>
            <option value="stripline">Stripline</option>
            <option value="diff_stripline">Differential Stripline</option>
            <option value="gcpw">GCPW</option>
            <option value="diff_gcpw">Differential GCPW</option>
        </select>
    </div>

    <div id="diff-params" style="display: none;">
        <div class="section-header" onclick="toggleSection(this)">
            <h3>Differential Pair</h3>
        </div>
        <div class="section-content">
            <div class="control-group">
                <label>Trace Spacing</label>
                <input type="text" class="unit-input" id="inp_trace_spacing" value="1.0 mm" step="0.1">
            </div>
        </div>
    </div>

    <div id="microstrip-params">
        <div class="section-header" onclick="toggleSection(this)">
            <h3>Geometry</h3>
        </div>
        <div class="section-content">
            <div class="control-group">
                <label>Trace Width</label>
                <input type="text" class="unit-input" id="inp_w" value="3.0 mm" step="0.1">
            </div>
            <div class="control-group">
                <label>Substrate Height</label>
                <input type="text" class="unit-input" id="inp_h" value="1.6 mm" step="0.1">
            </div>
            <div class="control-group">
                <label>Trace Thickness</label>
                <input type="text" class="unit-input" id="inp_t" value="35 μm" step="1">
            </div>
            <div class="control-group">
                <label>Relative Permittivity (&epsilon;<sub>r</sub>)</label>
                <input type="number" id="inp_er" value="4.5" step="0.1">
            </div>
            <div class="control-group">
                <label>Loss Tangent (tan &delta;)</label>
                <input type="number" id="inp_tand" value="0.02" step="0.001">
            </div>
            <div class="control-group">
                <label>Conductivity (S/m)</label>
                <input type="number" id="inp_sigma" value="5.8e7" step="1e6">
            </div>
        </div>
    </div>

    <div id="freq-sweep-params">
        <div class="section-header" onclick="toggleSection(this)">
            <h3>Frequency Sweep</h3>
        </div>
        <div class="section-content">
            <div class="control-group">
                <label>Start Frequency</label>
                <input type="text" class="unit-input" id="freq-start" value="0.1 GHz" step="0.1" min="0.001">
            </div>
            <div class="control-group">
                <label>Stop Frequency</label>
                <input type="text" class="unit-input" id="freq-stop" value="10 GHz" step="0.1" min="0.001">
            </div>
            <div class="control-group">
                <label>Points</label>
                <input type="number" id="freq-points" value="51" min="2" max="201" step="1">
            </div>
        </div>
    </div>
    <div id="gcpw-params" style="display: none;">
        <div class="section-header" onclick="toggleSection(this)">
            <h3>GCPW Parameters</h3>
        </div>
        <div class="section-content">
            <div class="control-group">
                <label>Gap</label>
                <input type="text" class="unit-input" id="inp_gap" value="0.1 mm" step="0.01">
            </div>
            <div class="control-group">
                <label>Top Ground Width</label>
                <input type="text" class="unit-input" id="inp_top_gnd_w" value="0.2 mm" step="0.01">
            </div>
            <div class="control-group">
                <label>Via Gap</label>
                <input type="text" class="unit-input" id="inp_via_gap" value="0.1 mm" step="0.01">
            </div>
        </div>
    </div>

    <div id="stripline-params" style="display: none;">
        <div class="section-header" onclick="toggleSection(this)">
            <h3>Stripline Parameters</h3>
        </div>
        <div class="section-content">
            <div class="control-group">
                <label>Top Dielectric Height</label>
                <input type="text" class="unit-input" id="inp_air_top" value="1.6 mm" step="0.01">
            </div>
            <div class="control-group">
                <label>Top Permittivity (&epsilon;<sub>r,top</sub>)</label>
                <input type="number" id="inp_er_top" value="4.5" step="0.1">
            </div>
            <div class="control-group">
                <label>Top Loss Tangent</label>
                <input type="number" id="inp_tand_top" value="0.02" step="0.01">
            </div>
        </div>
    </div>

    <div id="advanced-params">
        <div class="section-header collapsed" onclick="toggleSection(this)">
            <h3>Advanced Options</h3>
        </div>
        <div class="section-content collapsed">

        <div class="control-group">
            <label><input type="checkbox" id="chk_solder_mask"> Enable Solder Mask</label>
        </div>
        <div id="solder-mask-params" style="display: none; margin-left: 10px; padding-left: 10px; border-left: 2px solid var(--border-color);">
            <div class="control-group">
                <label>Mask over Substrate</label>
                <input type="text" class="unit-input" id="inp_sm_t_sub" value="20 μm" step="1">
            </div>
            <div class="control-group">
                <label>Mask over Trace</label>
                <input type="text" class="unit-input" id="inp_sm_t_trace" value="20 μm" step="1">
            </div>
            <div class="control-group">
                <label>Mask Side Thickness</label>
                <input type="text" class="unit-input" id="inp_sm_t_side" value="20 μm" step="1">
            </div>
            <div class="control-group">
                <label>Mask Permittivity (&epsilon;<sub>r,sm</sub>)</label>
                <input type="number" id="inp_sm_er" value="3.5" step="0.1">
            </div>
            <div class="control-group">
                <label>Mask Loss Tangent</label>
                <input type="number" id="inp_sm_tand" value="0.02" step="0.001">
            </div>
        </div>

        <div class="control-group">
            <label><input type="checkbox" id="chk_top_diel"> Enable Top Dielectric</label>
        </div>
        <div id="top-diel-params" style="display: none; margin-left: 10px; padding-left: 10px; border-left: 2px solid var(--border-color);">
            <div class="control-group">
                <label>Top Dielectric Height</label>
                <input type="text" class="unit-input" id="inp_top_diel_h" value="0.2 mm" step="0.01">
            </div>
            <div class="control-group">
                <label>Top Dielectric Permittivity</label>
                <input type="number" id="inp_top_diel_er" value="4.5" step="0.1">
            </div>
            <div class="control-group">
                <label>Top Dielectric Loss Tangent</label>
                <input type="number" id="inp_top_diel_tand" value="0.02" step="0.001">
            </div>
        </div>

        <div class="control-group">
            <label><input type="checkbox" id="chk_gnd_cut"> Enable Ground Cutout</label>
        </div>
        <div id="gnd-cut-params" style="display: none; margin-left: 10px; padding-left: 10px; border-left: 2px solid var(--border-color);">
            <div class="control-group">
                <label>Cutout Width</label>
                <input type="text" class="unit-input" id="inp_gnd_cut_w" value="3.0 mm" step="0.1">
            </div>
            <div class="control-group">
                <label>Substrate Below Cutout</label>
                <input type="text" class="unit-input" id="inp_gnd_cut_h" value="1.0 mm" step="0.1">
            </div>
        </div>

        <div class="control-group">
            <label><input type="checkbox" id="chk_enclosure"> Enable Enclosure</label>
        </div>
        <div id="enclosure-params" style="display: none; margin-left: 10px; padding-left: 10px; border-left: 2px solid var(--border-color);">
            <div class="control-group">
                <label><input type="checkbox" id="chk_side_gnd"> Side Ground</label>
            </div>
            <div class="control-group" id="top-gnd-group">
                <label><input type="checkbox" id="chk_top_gnd"> Top Ground</label>
            </div>
            <div class="control-group">
                <label>Width</label>
                <input type="text" class="unit-input" id="inp_enclosure_width" placeholder="auto" step="0.1">
            </div>
            <div class="control-group" id="enclosure-height-group">
                <label>Height</label>
                <input type="text" class="unit-input" id="inp_enclosure_height" placeholder="auto" step="0.1">
            </div>
        </div>

        <div class="control-group">
            <label>Surface Roughness RMS <span class="help-icon" onclick="showHelpModal('roughness')">?</span></label>
            <input type="text" class="unit-input" id="inp_rq" value="0 μm" step="0.1" min="0">
        </div>
        </div>
    </div>


    <div id="plot-options">
    <div class="section-header" onclick="toggleSection(this)">
        <h3>Plot Options</h3>
    </div>
    <div class="section-content">
        <!-- Mode selector hidden - now in Plotly menu -->
        <select id="plot-mode" style="display: none;">
            <option value="odd">Odd</option>
            <option value="even">Even</option>
        </select>
        <div class="control-group">
            <label>Streamlines</label>
            <input type="number" id="plot-streamlines" value="20" step="5" min="0" placeholder="None">
        </div>
        <div class="control-group">
            <label>Contours</label>
            <input type="number" id="plot-contours" value="" step="5" min="0" placeholder="None">
        </div>
    </div>
    </div>

    <div id="solver-settings">
    <div class="section-header" onclick="toggleSection(this)">
        <h3>Solver Settings</h3>
    </div>
    <div class="section-content">
    <div class="control-group">
        <label>Max Iterations</label>
        <input type="number" id="inp_max_iters" value="10" step="1" min="1">
    </div>
    <div class="control-group">
        <label>Max Nodes</label>
        <input type="number" id="inp_max_nodes" value="20000" step="1000" min="1000">
    </div>
    <div class="control-group">
        <label>Tolerance <span class="help-icon" onclick="showHelpModal('tolerance')">?</span></label>
        <input type="number" id="inp_tolerance" value="0.05" step="0.01" min="0.001">
    </div>
    </div>
    </div>

    <button id="btn_solve">Solve Physics</button>

    <div class="progress-container" id="progress_container">
        <div class="progress-bar" id="progress_bar"></div>
    </div>
    <div id="progress_text" style="font-size: 0.85em; margin-top: 5px; color: #6b7280; display: none;"></div>
</div>

<div class="main-content">
    <div class="tab-bar">
        <button class="tab-button active" data-tab="geometry">Geometry</button>
        <button class="tab-button" data-tab="results">Results</button>
        <button class="tab-button" data-tab="sparams">S-Parameters</button>
        <button class="tab-button" data-tab="about">About</button>
    </div>

    <div id="tab-geometry" class="tab-content active">
        <div class="canvas-container">
            <div id="sim_canvas"></div>
        </div>
    </div>

    <div id="tab-results" class="tab-content">
        <div class="results-controls">
            <select id="results-plot-selector">
                <option value="re_z0">Re(Z0)</option>
                <option value="im_z0">Im(Z0)</option>
                <option value="loss">Loss (dB/m)</option>
                <option value="R">R (Ohm/m)</option>
                <option value="L">L (H/m)</option>
                <option value="C">C (F/m)</option>
                <option value="G">G (S/m)</option>
            </select>
        </div>
        <div id="results-plot" class="plot-container"></div>
        <div class="results-controls bottom">
            <label class="checkbox-label"><input type="checkbox" id="results-log-x"> Log frequency axis</label>
            <button id="copy-link-btn">Copy link</button>
            <div id="results-notice" style="display: none; padding: 6px 10px; background: #fef3c7; border-left: 3px solid #f59e0b; font-size: 0.8em; border-radius: 3px;">
                <strong>⚠</strong> <span id="results-notice-text"></span>
            </div>
        </div>
    </div>

    <div id="tab-sparams" class="tab-content">
        <div class="results-controls">
            <select id="sparam-plot-mode">
                <option value="magnitude">Magnitude (dB)</option>
                <option value="phase">Phase (degrees)</option>
            </select>
        </div>
        <div id="sparam-plot" class="plot-container"></div>
        <div class="sparam-controls">
            <label class="checkbox-label"><input type="checkbox" id="sparam-log-x"> Log frequency axis</label>
            <label>Line Length: <input type="text" class="unit-input" id="sparam-length" value="10 mm" step="0.001"></label>
            <label>Reference Impedance: <input type="number" id="sparam-z-ref" value="50" step="1" min="1"> Ohm</label>
            <button id="export-snp">Export SnP file</button>
            <div id="sparam-notice" style="display: none; padding: 6px 10px; background: #fef3c7; border-left: 3px solid #f59e0b; font-size: 0.8em; border-radius: 3px; flex-shrink: 0;">
                <strong>⚠</strong> <span id="sparam-notice-text"></span>
            </div>
        </div>
    </div>

    <div id="tab-about" class="tab-content">
        <div class="about-content">
            <h2>2D Transmission Line Field Solver</h2>
            <p>A quasi-static 2D field solver for transmission line analysis using the finite difference method with adaptive mesh refinement.</p>

            <h3>Methodology</h3>
            <p>The solver computes the characteristic impedance and propagation parameters of transmission lines by solving Laplace's equation for the electric potential distribution in the cross-section:</p>
            <p style="text-align: center; font-family: serif; font-size: 1.1em;">&nabla;&sup2;V = 0</p>
            <p>From the potential solution, the capacitance per unit length is calculated by integrating the electric field around the conductor. The inductance is determined by solving the same problem with air dielectric to find C<sub>0</sub>, then using:</p>
            <p style="text-align: center; font-family: serif; font-size: 1.1em;">L = 1 / (c&sup2; &middot; C<sub>0</sub>)</p>
            <p>where c is the speed of light.</p>

            <h3>Loss Calculations</h3>
            <p><strong>Conductor loss</strong> is computed using Wheeler's incremental inductance rule, with skin effect and surface roughness corrections. The surface roughness model follows the gradient approach from <a href="https://ieeexplore.ieee.org/document/7932148" target="_blank">IEEE literature</a>.</p>
            <p><strong>Dielectric loss</strong> is calculated from the loss tangent of each dielectric region, weighted by the field energy distribution.</p>

            <h3>S-Parameters</h3>
            <p>S-parameters are computed from the RLGC transmission line model using standard ABCD matrix formulation. For differential lines, modal decomposition separates odd and even modes, which are then combined into 4-port S-parameters.</p>

            <h3>Adaptive Mesh Refinement</h3>
            <p>The solver uses adaptive mesh refinement to concentrate grid points where the field gradients are highest (near conductor edges and dielectric interfaces), improving accuracy while keeping computation tractable.</p>
        </div>
    </div>

    <div class="output-panel" id="console_out">Ready. Click 'Solve Physics' to start simulation.</div>
</div>

<!-- Help Modal -->
<div id="helpModal" class="help-modal">
    <div class="help-modal-content">
        <span class="help-modal-close" onclick="closeHelpModal()">&times;</span>
        <h3 id="helpModalTitle"></h3>
        <div id="helpModalBody"></div>
    </div>
</div>

<script>
    // ========== Unit Parsing System ==========

    /**
     * Parse a value with optional unit suffix and convert to SI base unit
     * @param {string|number} input - Value with optional unit (e.g., "1mm", "0.001 mil", "10 GHz")
     * @param {string} defaultUnit - Default unit if none specified (e.g., "mm", "μm", "GHz", "Hz")
     * @returns {number} - Value in SI base unit (meters for length, Hz for frequency)
     */
    function parseValueWithUnit(input, defaultUnit = '') {
        if (typeof input === 'number') return input;
        if (!input || input.trim() === '') return NaN;

        const str = input.toString().trim().toLowerCase();

        // Match number (with optional sign, decimal, scientific notation) followed by optional unit
        const match = str.match(/^([+-]?(?:\d+\.?\d*|\.\d+)(?:[e][+-]?\d+)?)\s*([a-zμµ]*)$/i);
        if (!match) return NaN;

        const value = parseFloat(match[1]);
        let unit = match[2] || defaultUnit.toLowerCase();

        // Normalize unicode variations
        unit = unit.replace(/µ/g, 'μ');

        // Length units - convert to meters
        const lengthUnits = {
            'm': 1,
            'meter': 1, 'meters': 1,
            'cm': 1e-2,
            'mm': 1e-3,
            'um': 1e-6, 'μm': 1e-6, 'micron': 1e-6, 'microns': 1e-6,
            'nm': 1e-9,
            'mil': 25.4e-6,  // 1 mil = 1/1000 inch = 25.4 μm
            'mils': 25.4e-6,
            'in': 25.4e-3,   // 1 inch = 25.4 mm
            'inch': 25.4e-3, 'inches': 25.4e-3,
            'ft': 0.3048,    // 1 foot = 0.3048 m
            'foot': 0.3048, 'feet': 0.3048,
        };

        // Frequency units - convert to Hz
        // Note: 'm' is MHz (milliHertz not supported), 't' is THz
        const frequencyUnits = {
            'hz': 1,
            'khz': 1e3, 'k': 1e3,
            'mhz': 1e6, 'm': 1e6,  // 'm' = MHz, not milliHertz
            'ghz': 1e9, 'g': 1e9,
            'thz': 1e12, 't': 1e12,
        };

        // Check length units first
        if (unit in lengthUnits) {
            return value * lengthUnits[unit];
        }

        // Check frequency units
        if (unit in frequencyUnits) {
            return value * frequencyUnits[unit];
        }

        // No unit specified and defaultUnit was provided - use default
        if (unit === '' && defaultUnit !== '') {
            // Reparse with default unit
            return parseValueWithUnit(value, defaultUnit);
        }

        // No unit specified and no default - return value as-is (assume SI base unit)
        if (unit === '') {
            return value;
        }

        // Unknown unit - return NaN to indicate invalid input
        return NaN;
    }

    /**
     * Format a value with appropriate unit for display
     * @param {number} valueInSI - Value in SI base unit
     * @param {string} preferredUnit - Preferred display unit (e.g., "mm", "GHz")
     * @returns {string} - Formatted string with unit
     */
    function formatValueWithUnit(valueInSI, preferredUnit) {
        if (isNaN(valueInSI) || valueInSI === null || valueInSI === undefined) return '';

        const unitMap = {
            'mm': { scale: 1e-3, symbol: 'mm' },
            'μm': { scale: 1e-6, symbol: 'μm' },
            'um': { scale: 1e-6, symbol: 'μm' },
            'mil': { scale: 25.4e-6, symbol: 'mil' },
            'in': { scale: 25.4e-3, symbol: 'in' },
            'GHz': { scale: 1e9, symbol: 'GHz' },
            'MHz': { scale: 1e6, symbol: 'MHz' },
            'kHz': { scale: 1e3, symbol: 'kHz' },
            'Hz': { scale: 1, symbol: 'Hz' },
        };

        const unit = unitMap[preferredUnit] || { scale: 1, symbol: '' };
        const displayValue = valueInSI / unit.scale;

        // Format with appropriate precision
        let formatted;
        if (Math.abs(displayValue) >= 1000) {
            formatted = displayValue.toExponential(3);
        } else if (Math.abs(displayValue) >= 100) {
            formatted = displayValue.toFixed(1);
        } else if (Math.abs(displayValue) >= 10) {
            formatted = displayValue.toFixed(2);
        } else if (Math.abs(displayValue) >= 1) {
            formatted = displayValue.toFixed(3);
        } else if (Math.abs(displayValue) >= 0.01) {
            formatted = displayValue.toFixed(4);
        } else {
            formatted = displayValue.toExponential(3);
        }

        // Remove trailing zeros after decimal point
        formatted = formatted.replace(/\.?0+$/, '').replace(/\.?0+(e)/, '$1');

        return unit.symbol ? formatted + ' ' + unit.symbol : formatted;
    }

    /**
     * Get the default/expected unit for an input field based on its ID and label
     */
    function getDefaultUnit(inputId) {
        const unitMap = {
            // Geometry - mm
            'inp_w': 'mm',
            'inp_h': 'mm',
            'inp_trace_spacing': 'mm',
            'inp_gap': 'mm',
            'inp_top_gnd_w': 'mm',
            'inp_via_gap': 'mm',
            'inp_air_top': 'mm',
            'inp_top_diel_h': 'mm',
            'inp_gnd_cut_w': 'mm',
            'inp_gnd_cut_h': 'mm',
            'inp_enclosure_width': 'mm',
            'inp_enclosure_height': 'mm',

            // Thickness - μm
            'inp_t': 'μm',
            'inp_sm_t_sub': 'μm',
            'inp_sm_t_trace': 'μm',
            'inp_sm_t_side': 'μm',
            'inp_rq': 'μm',

            // Frequency - GHz
            'freq-start': 'GHz',
            'freq-stop': 'GHz',

            // S-param length - mm
            'sparam-length': 'mm',
        };

        return unitMap[inputId] || '';
    }

    /**
     * Validate an input field with units (but don't modify user input)
     * Provides visual feedback for invalid units
     */
    function parseAndNormalizeInput(inputElement) {
        const inputValue = inputElement.value.trim();
        if (!inputValue) return;

        const defaultUnit = getDefaultUnit(inputElement.id);
        const parsedSI = parseValueWithUnit(inputValue, defaultUnit);

        if (isNaN(parsedSI)) {
            inputElement.classList.add('invalid');
            inputElement.title = 'Invalid unit';
        } else {
            inputElement.classList.remove('invalid');
            inputElement.title = '';
        }
    }

    /**
     * Get numeric value from input field, parsing units
     * This should be used instead of parseFloat() for unit-aware inputs
     * @param {string} inputId - ID of the input element
     * @param {number} conversionFactor - Optional factor to multiply (for backward compatibility)
     * @returns {number} - Parsed value in SI units (or multiplied by conversionFactor)
     */
    window.getInputValue = function(inputId, conversionFactor = 1) {
        const element = document.getElementById(inputId);
        if (!element) return NaN;

        const defaultUnit = getDefaultUnit(inputId);
        const valueSI = parseValueWithUnit(element.value, defaultUnit);

        return valueSI * conversionFactor;
    };

    // Export for use in modules
    window.parseValueWithUnit = parseValueWithUnit;
    window.formatValueWithUnit = formatValueWithUnit;
    window.getDefaultUnit = getDefaultUnit;

    // Collapsible Section Toggle
    function toggleSection(header) {
        header.classList.toggle('collapsed');
        const content = header.nextElementSibling;
        if (content && content.classList.contains('section-content')) {
            content.classList.toggle('collapsed');
        }
    }

    // Help Modal Functions
    const helpContent = {
        roughness: {
            title: 'Surface Roughness',
            body: '<p>Conductor loss is calculated using gradient model (<a href="https://ieeexplore.ieee.org/document/7932148" target="_blank">https://ieeexplore.ieee.org/document/7932148</a>), both loss and inductance caused by the surface roughness is calculated. All conductors use this roughness on all sides. Typical RMS roughness is about 1 - 2 µm for normal copper foil and about 0.5 µm for special low profile foil.</p>'
        },
        tolerance: {
            title: 'Tolerance',
            body: '<p>Terminates adaptive mesh refinement if the relative change in the total energy stored in electromagnetic field changes less than this value between iterations. 0.05 should be a good balance between fast calculation and good results. Decrease to 0.01 or less for more accurate results. Param error in log is relative error between calculated output parameters Z0 and C.</p>'
        }
    };

    function showHelpModal(topic) {
        const content = helpContent[topic];
        if (content) {
            document.getElementById('helpModalTitle').textContent = content.title;
            document.getElementById('helpModalBody').innerHTML = content.body;
            document.getElementById('helpModal').style.display = 'block';
        }
    }

    function closeHelpModal() {
        document.getElementById('helpModal').style.display = 'none';
    }

    // Close modal when clicking outside of it
    window.onclick = function(event) {
        const modal = document.getElementById('helpModal');
        if (event.target === modal) {
            closeHelpModal();
        }
    }

    function toggleParameterVisibility() {
        const tlType = document.getElementById('tl_type').value;
        const microstripParams = document.getElementById('microstrip-params');
        const diffParams = document.getElementById('diff-params');
        const gcpwParams = document.getElementById('gcpw-params');
        const striplineParams = document.getElementById('stripline-params');
        const advancedParams = document.getElementById('advanced-params');
        const solderMaskGroup = advancedParams.querySelector('.control-group:has(#chk_solder_mask)');
        const solderMaskParams = document.getElementById('solder-mask-params');
        const topDielGroup = advancedParams.querySelector('.control-group:has(#chk_top_diel)');
        const topDielParams = document.getElementById('top-diel-params');
        const gndCutGroup = advancedParams.querySelector('.control-group:has(#chk_gnd_cut)');
        const gndCutParams = document.getElementById('gnd-cut-params');
        const enclosureGroup = advancedParams.querySelector('.control-group:has(#chk_enclosure)');
        const enclosureParams = document.getElementById('enclosure-params');
        const topGndGroup = document.getElementById('top-gnd-group');
        const enclosureHeightGroup = document.getElementById('enclosure-height-group');

        // Hide all type-specific params first
        diffParams.style.display = 'none';
        gcpwParams.style.display = 'none';
        striplineParams.style.display = 'none';

        // Common params always visible
        microstripParams.style.display = 'block';

        // Always show advanced params
        advancedParams.style.display = 'block';

        // Get the checkboxes
        const chkSolderMask = document.getElementById('chk_solder_mask');
        const chkTopDiel = document.getElementById('chk_top_diel');
        const chkGndCut = document.getElementById('chk_gnd_cut');
        const chkEnclosure = document.getElementById('chk_enclosure');

        if (tlType === 'microstrip') {
            // Enable all advanced options for microstrip
            if (solderMaskGroup) solderMaskGroup.style.display = 'block';
            if (topDielGroup) topDielGroup.style.display = 'block';
            if (gndCutGroup) gndCutGroup.style.display = 'block';
            if (enclosureGroup) enclosureGroup.style.display = 'block';
            if (topGndGroup) topGndGroup.style.display = 'block';
            if (enclosureHeightGroup) enclosureHeightGroup.style.display = 'block';
            if (chkSolderMask) chkSolderMask.disabled = false;
            if (chkTopDiel) chkTopDiel.disabled = false;
            if (chkGndCut) chkGndCut.disabled = false;
            if (chkEnclosure) chkEnclosure.disabled = false;
        } else if (tlType === 'diff_microstrip') {
            diffParams.style.display = 'block';
            // Enable all advanced options for diff microstrip
            if (solderMaskGroup) solderMaskGroup.style.display = 'block';
            if (topDielGroup) topDielGroup.style.display = 'block';
            if (gndCutGroup) gndCutGroup.style.display = 'block';
            if (enclosureGroup) enclosureGroup.style.display = 'block';
            if (topGndGroup) topGndGroup.style.display = 'block';
            if (enclosureHeightGroup) enclosureHeightGroup.style.display = 'block';
            if (chkSolderMask) chkSolderMask.disabled = false;
            if (chkTopDiel) chkTopDiel.disabled = false;
            if (chkGndCut) chkGndCut.disabled = false;
            if (chkEnclosure) chkEnclosure.disabled = false;
        } else if (tlType === 'stripline') {
            striplineParams.style.display = 'block';
            // Show but disable all advanced options for stripline
            if (solderMaskGroup) solderMaskGroup.style.display = 'block';
            if (topDielGroup) topDielGroup.style.display = 'block';
            if (gndCutGroup) gndCutGroup.style.display = 'block';
            if (enclosureGroup) enclosureGroup.style.display = 'block';
            // Hide top ground checkbox and height for stripline (already has top ground)
            if (topGndGroup) topGndGroup.style.display = 'none';
            if (enclosureHeightGroup) enclosureHeightGroup.style.display = 'none';
            if (chkSolderMask) {
                chkSolderMask.disabled = true;
                chkSolderMask.checked = false;
                solderMaskParams.style.display = 'none';
            }
            if (chkTopDiel) {
                chkTopDiel.disabled = true;
                chkTopDiel.checked = false;
                topDielParams.style.display = 'none';
            }
            if (chkGndCut) {
                chkGndCut.disabled = true;
                chkGndCut.checked = false;
                gndCutParams.style.display = 'none';
            }
            if (chkEnclosure) {
                chkEnclosure.disabled = false;
            }
        } else if (tlType === 'diff_stripline') {
            diffParams.style.display = 'block';
            striplineParams.style.display = 'block';
            // Show but disable all advanced options for diff stripline (same as stripline)
            if (solderMaskGroup) solderMaskGroup.style.display = 'block';
            if (topDielGroup) topDielGroup.style.display = 'block';
            if (gndCutGroup) gndCutGroup.style.display = 'block';
            if (enclosureGroup) enclosureGroup.style.display = 'block';
            // Hide top ground checkbox and height for diff stripline (already has top ground)
            if (topGndGroup) topGndGroup.style.display = 'none';
            if (enclosureHeightGroup) enclosureHeightGroup.style.display = 'none';
            if (chkSolderMask) {
                chkSolderMask.disabled = true;
                chkSolderMask.checked = false;
                solderMaskParams.style.display = 'none';
            }
            if (chkTopDiel) {
                chkTopDiel.disabled = true;
                chkTopDiel.checked = false;
                topDielParams.style.display = 'none';
            }
            if (chkGndCut) {
                chkGndCut.disabled = true;
                chkGndCut.checked = false;
                gndCutParams.style.display = 'none';
            }
            if (chkEnclosure) {
                chkEnclosure.disabled = false;
            }
        } else if (tlType === 'gcpw') {
            gcpwParams.style.display = 'block';
            // Enable all advanced options for GCPW
            if (solderMaskGroup) solderMaskGroup.style.display = 'block';
            if (topDielGroup) topDielGroup.style.display = 'block';
            if (gndCutGroup) gndCutGroup.style.display = 'block';
            if (enclosureGroup) enclosureGroup.style.display = 'block';
            if (topGndGroup) topGndGroup.style.display = 'block';
            if (enclosureHeightGroup) enclosureHeightGroup.style.display = 'block';
            if (chkSolderMask) chkSolderMask.disabled = false;
            if (chkTopDiel) chkTopDiel.disabled = false;
            if (chkGndCut) chkGndCut.disabled = false;
            if (chkEnclosure) chkEnclosure.disabled = false;
        } else if (tlType === 'diff_gcpw') {
            diffParams.style.display = 'block';
            gcpwParams.style.display = 'block';
            // Enable all advanced options for diff GCPW
            if (solderMaskGroup) solderMaskGroup.style.display = 'block';
            if (topDielGroup) topDielGroup.style.display = 'block';
            if (gndCutGroup) gndCutGroup.style.display = 'block';
            if (enclosureGroup) enclosureGroup.style.display = 'block';
            if (topGndGroup) topGndGroup.style.display = 'block';
            if (enclosureHeightGroup) enclosureHeightGroup.style.display = 'block';
            if (chkSolderMask) chkSolderMask.disabled = false;
            if (chkTopDiel) chkTopDiel.disabled = false;
            if (chkGndCut) chkGndCut.disabled = false;
            if (chkEnclosure) chkEnclosure.disabled = false;
        }
    }

    function toggleCheckboxSection(checkboxId, sectionId) {
        const checkbox = document.getElementById(checkboxId);
        const section = document.getElementById(sectionId);
        section.style.display = checkbox.checked ? 'block' : 'none';
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('tl_type').addEventListener('change', toggleParameterVisibility);
        toggleParameterVisibility(); // Set initial visibility

        // Checkbox toggles for advanced options
        document.getElementById('chk_solder_mask').addEventListener('change', () => {
            toggleCheckboxSection('chk_solder_mask', 'solder-mask-params');
        });
        document.getElementById('chk_top_diel').addEventListener('change', () => {
            toggleCheckboxSection('chk_top_diel', 'top-diel-params');
        });
        document.getElementById('chk_gnd_cut').addEventListener('change', () => {
            toggleCheckboxSection('chk_gnd_cut', 'gnd-cut-params');
        });
        document.getElementById('chk_enclosure').addEventListener('change', () => {
            toggleCheckboxSection('chk_enclosure', 'enclosure-params');
        });

        // Initialize checkbox sections based on restored state (for browser auto-restore)
        toggleCheckboxSection('chk_solder_mask', 'solder-mask-params');
        toggleCheckboxSection('chk_top_diel', 'top-diel-params');
        toggleCheckboxSection('chk_gnd_cut', 'gnd-cut-params');
        toggleCheckboxSection('chk_enclosure', 'enclosure-params');

        // Setup unit parsing for all unit-input fields
        document.querySelectorAll('.unit-input').forEach(input => {
            // Parse on blur
            input.addEventListener('blur', function() {
                parseAndNormalizeInput(this);
            });

            // Parse on Enter key
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    parseAndNormalizeInput(this);
                    this.blur();
                }
            });
        });
    });
</script>
<script type="module" src="app.js"></script>

</body>
</html>
